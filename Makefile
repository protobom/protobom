# ANSI color escape codes
BOLD :=  \033[1m
CYAN :=  \033[36m
GREEN := \033[32m
RESET := \033[0m

VERSION ?= ${shell git describe --tags --abbrev=0}

.PHONY: help
help:
	@grep -Eh '^[a-zA-Z_-]+:.*?## .*$$' ${MAKEFILE_LIST} | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "${BOLD}${CYAN}%-25s${RESET}%s\n", $$1, $$2}'

.PHONY: conformance
conformance: ## Regenerate the conformance golden samples. Only to be run when changes are expected
	go run ./test/conformance/generator/ test/conformance/testdata/

.PHONY: conformance-test
conformance-test: ## Run the conformance test suite
	go test ./test/conformance/...

.PHONY: fakes
fakes: ## Rebuild the fake implementations
	go generate ./...

.PHONY: buf-format
buf-format: ## Check for breaking changes in protocol buffer definitions
	buf format --write

.PHONY: buf-lint
buf-lint: ## Check for breaking changes in protocol buffer definitions
	buf format --diff --exit-code
	buf lint
	buf breaking --against https://github.com/protobom/protobom.git#tag=${VERSION},subdir=api

.PHONY: proto
proto: ## Rebuild protobuf autogenerated code
	buf generate
	go generate api/generate.go
